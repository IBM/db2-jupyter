<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Stored Procedures - Db2 Magic Commands</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Stored Procedures";
    var mkdocs_page_input_path = "stored_procedures.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Db2 Magic Commands</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../connect/">Getting Connected</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../linevscell/">SQL Magic Commands</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../sql_options/">SQL Options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../command_options/">Db2 Magic Command Options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../plotting/">Plotting</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../variables/">Variables</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../resultsets/">Result Sets</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Stored Procedures</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#stored-procedure-parameters">Stored Procedure Parameters</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#system-stored-procedures">System Stored Procedures</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../developmentsql/">Development SQL</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../pandasdb2/">Pandas to Db2</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../parallel/">Parallel SQL</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../macros/">Macros</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../extramacros/">Predefined Macros</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../support/">Support</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Db2 Magic Commands</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Stored Procedures</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="stored-procedures">Stored Procedures</h1>
<p>The <code>%sql</code> command supports calls to stored procedures, but there are limitations to how it is used. The following restrictions apply:</p>
<ul>
<li>Only one answer set (cursor) is available from the stored procedure</li>
<li>Accessing output values from the procedure requires the use of the <code>-r</code> (raw) flag</li>
<li>Output is available either as a pandas dataframe, or as an array</li>
</ul>
<p>The following stored procedure returns the first and last name of all employees. There are no parameters passed to the procedure.</p>
<p>Some important points about the stored procedure itself:</p>
<ul>
<li>The procedure must declare that there are answer sets with the <code>DYNAMIC RESULTS SETS</code> clause</li>
<li>A cursor must be declared and then left open</li>
</ul>
<p>If you create more than one cursor, only the first one will get processed by the routine.</p>
<pre><code>%%sql -d
CREATE OR REPLACE PROCEDURE SHOWEMP
DYNAMIC RESULT SETS 1
begin
    DECLARE c1 CURSOR WITH RETURN TO CALLER FOR
       SELECT FIRSTNME, LASTNAME FROM EMPLOYEE;
    OPEN c1;
end@
</code></pre>
<p>Calling the stored procedure is done using the standard <code>SQL CALL procname(arguments)</code> format. There are specific rules for supplying arguments to a stored procedure:</p>
<ul>
<li>The CALL command is supported in a <code>%sql</code> statement only. It cannot be used as part of a <code>%%sql</code> block.</li>
<li>Null arguments must use the <code>null</code> keyword, rather than the Python <code>None</code> equivalent.</li>
<li>Brackets <code>()</code> are not required for stored procedures that have no arguments.</li>
</ul>
<p>The next statement will execute the stored procedure and display the results by default.
<img alt="Stored Procs" src="../img/storeproc1.png" /></p>
<p>Adding the <code>-a</code> (all output) flag to a stored procedure call will display all results. This is the same behavior when running regular SQL statements. If you want to assign the result to a variable, you only need to add an assignment statement to the SQL.
<img alt="Stored Procs" src="../img/storeproc2.png" /></p>
<p>The use of the <code>-r</code>(raw output) flag will force the output to be converted into a two-dimensional array. The first line of th array will contain the column names, while the remainder will have the results in it. This format is useful if you want to write an application in Python to manipulate the data.</p>
<pre><code>%sql -r CALL SHOWEMP
</code></pre>
<p>The stored procedure is now modified to accept a single argument which is the employee number. The employee number is supplied to the stored procedure and one record is returned with all of the details of the employee.</p>
<pre><code>%%sql -d
CREATE OR REPLACE PROCEDURE SHOWEMP(in inempno char(6))
DYNAMIC RESULT SETS 1
begin
    DECLARE c1 CURSOR WITH RETURN TO CALLER FOR
       SELECT * FROM EMPLOYEE WHERE EMPNO=inempno;
    OPEN c1;
end@
</code></pre>
<p>When calling this procedure we must supply the employee number as a 6 character field. The behavior will be similar to the first example with no parameters.
<img alt="Stored Procs" src="../img/storeproc3.png" /></p>
<p>If you use the standard <code>%sql</code> command without the <code>-r</code> parameter, only the answer set will be returned or displayed. An assignment statement with <code>-r</code>is slightly more complex:</p>
<ul>
<li>The first value will be the array of results</li>
<li>Subsequent values will be the input/output parameters of the stored procedure </li>
</ul>
<p>The next SQL statement will assign the results to a single variable.</p>
<pre><code>results = %sql -r CALL SHOWEMP('000010')
</code></pre>
<p>The first value in the results array (<code>results[0]</code>) is the answer set array, while the subsequent values are the parameters that are passed (or returned) by the stored procedure. <code>results[1]</code> will be equal to the employee number we were searching for.
<img alt="Stored Procs" src="../img/storeproc4.png" /></p>
<p>The use of the <code>-r</code>flag becomes mandatory when you are retrieving an answer set from a stored procedure, and also need to access the return results of the arguments to the stored procedure. SQL stored procedures can have input, output, and input/output values. These values are returned back via the <code>%sql</code> command but can only be accessed when you use the <code>-r</code> flag.</p>
<p>The following stored procedure will return the employees in a department and also a count of the records found.</p>
<pre><code>%%sql -d
create or replace procedure showdept(in indeptno char(3), out rowcount int)
DYNAMIC RESULT SETS 1
begin
    DECLARE c1 CURSOR WITH RETURN TO CALLER FOR
       SELECT * FROM EMPLOYEE WHERE WORKDEPT=indeptno;
    set rowcount = (SELECT COUNT(*) FROM EMPLOYEE WHERE WORKDEPT=indeptno);
    OPEN c1;
end@
</code></pre>
<p>A normal call to this stored procedure (no flags) will return the result set. Note we must supply the second parameter here but do not supply a value since it is an output value. The <code>null</code> keyword must be used.
<img alt="Stored Procs" src="../img/storeproc5.png" /></p>
<p>To access the value of the rowcount, the <code>-r</code>flag must be used and the results assigned to a variable.
<img alt="Stored Procs" src="../img/storeproc6.png" /></p>
<p>The first value of the <code>results</code> array will the answer set as an array. The second value will be the department that we requested, and the third will be the rowcount.</p>
<p>An alternative way of accessing the results is to create an assignment statement with the answer set and all of the parameters supplied. The following SQL will assign the answer set and parameters directly to variables rather than an array.
<img alt="Stored Procs" src="../img/storeproc7.png" /></p>
<p>Stored procedures without answer sets will always return the parameters or <code>None</code> if nothing was supplied. This simple stored procedure increments the number that was sent to it.</p>
<h2 id="stored-procedure-parameters">Stored Procedure Parameters</h2>
<p>Stored procedures can have variables passed as parameters. To pass a parameter to a stored procedure, place a colon (:) in front of the variable name:</p>
<pre><code>%sql CALL SHOWDEPT(:deptno,null)
</code></pre>
<p>The python variable <code>deptno</code> will be substituted into the <code>CALL</code> statement when it is executed.</p>
<pre><code>%%sql -d
CREATE or REPLACE PROCEDURE DEPTCOUNT(in indeptno char(3), out rowcount int)
begin
    set rowcount = (SELECT COUNT(*) FROM EMPLOYEE WHERE WORKDEPT=indeptno);
end@
</code></pre>
<p>The following code will go through each department number and get a count of employees by calling the stored procedure. Note that an answer set return using raw format always returns an array of rows, and each row itself is made up of an array of columns. The code needs to iterate across the rows and then across the columns. The first row of the answer set is the column names, so we skip that by using <code>depts[1:]</code> as the starting point.
<img alt="Stored Procs" src="../img/storeproc8.png" /></p>
<h2 id="system-stored-procedures">System Stored Procedures</h2>
<p>The Db2 System Stored procedures work using this syntax except for procedures that return binary XML output. At this point in time there is a limitation in retrieving this data using the Python Db2 API calls that are available. An example of a working procedure call is the <code>REORGCHK</code> procedure.
<img alt="Stored Procs" src="../img/storeproc9.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../developmentsql/" class="btn btn-neutral float-right" title="Development SQL">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../resultsets/" class="btn btn-neutral" title="Result Sets"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../resultsets/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../developmentsql/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
